nextflow_process {

    name "Test Process KRAKEN2"
    script "modules/local/kraken2/main.nf"
    process "KRAKEN2"

    test("Should run with paired-end reads") {
        when {
            params {
                outdir = "test-results"
                krakendb = "test-data/minikraken-db"
                kraken_threads = 2
                container_kraken2 = "quay.io/biocontainers/kraken2:2.1.2--pl5321h9f5acd7_2"
            }
            
            process {
                """
                input[0] = "test_sample"
                input[1] = [ file("test-data/reads/test_sample_1.fastp.fastq.gz"), file("test-data/reads/test_sample_2.fastp.fastq.gz") ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.report != null
            
            // Check file existence (using paths)
            with(process.out.report) {
                def reportFile = process.out.report[1]
                assert path(reportFile).getName().endsWith('.kraken2.report')
            }
            
            // Validate that the sample ID is passed through correctly
            def sampleId = process.out.report[0]
            assert sampleId == "test_sample"
        }
    }
}